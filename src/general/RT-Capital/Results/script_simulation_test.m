clear
clc

% mex Fsimulation.f90 COMPFLAGS="/Qopenmp $COMPFLAGS" ...
%  -I"C:\Program Files (x86)\VNI\imsl\fnl600\intel64\include\dll"
% mex Fsimulation.f90 COMPFLAGS="/Qopenmp $COMPFLAGS" ...
%     -I"C:\Program Files (x86)\VNI\imsl\fnl701\Intel64\include\dll"

load('solutions/solution_test.mat');
V = variables;

%% Check stoch ss
npers = 25;
e = zeros(npers,1);
u = zeros(npers,1);

sims = Fsimulation(...
        zeros(V.nvar,1),...
        P.varphi,P.pi,P.zlb,P.phipi,P.phiy,...
        P.theta,P.rhor,P.eta,P.h,P.alpha,...
        P.delta,P.nu,P.g,P.rhog,P.beta,P.rhobeta,...
        S.c,S.k,S.i,S.r,S.chi,...
        V.g,V.beta,V.n,V.pi,V.psi,...        
        V.y,V.rn,V.r,V.w,V.c,V.i,V.k,V.rgdp,...
        G.c_grid,G.k_grid,G.i_grid,...
        G.rn_grid,G.g_grid,G.beta_grid,...
        pf.n,pf.pi,pf.psi,...
        e,u);
stochss1 = sims(end,:);
sims = simulation(pf,P,S,G,V,e,u);
stochss2 = sims(end,:);
disp(abs(stochss1-stochss2))

%% Unconditional simulation

npers = 100000;
nsims = 1;
e = P.sige*randn(npers,nsims);
u = P.sigu*randn(npers,nsims);
sims = Fsimulation(...
        zeros(V.nvar,1),...
        P.varphi,P.pi,P.zlb,P.phipi,P.phiy,...
        P.theta,P.rhor,P.eta,P.h,P.alpha,...
        P.delta,P.nu,P.g,P.rhog,P.beta,P.rhobeta,...
        S.c,S.k,S.i,S.r,S.chi,...
        V.g,V.beta,V.n,V.pi,V.psi,...        
        V.y,V.rn,V.r,V.w,V.c,V.i,V.k,V.rgdp,...
        G.c_grid,G.k_grid,G.i_grid,...
        G.rn_grid,G.g_grid,G.beta_grid,...
        pf.n,pf.pi,pf.psi,...
        e,u);

%%
simsquant = quantile(sims,[.01,.99],1);
disp('Simulation 1/99 percentiles')
disp('    c        k        i        rn  ')
disp(simsquant(:,[V.c,V.k,V.i,V.rn]))
disp('Bounds')
disp('    c        k        i        rn  ')
disp([O.cbound',O.kbound',O.ibound',O.rnbound'])